<h2>GetCandy - Laravel <br> e-commerce package</h2>

<img style="height: 8em" data-src="presentations/2022-07-06-get-candy/images/getcandy_icon.svg">

<p>Adrian Gawle 06.07.2022</p>

---

## E-commerce

<p>E-commerce (electronic commerce) is the buying and selling of goods and services,
or transmitting of funds or data, over an electronic network, primarily the internet. These transactions occur either as:</p>
<ul>
<li>B2B - business-to-business</li>
<li>B2C - business-to-consumer</li>
</ul>

---

## GetCandy

<p>
An opensource headless e-commerce package built on Laravel. It provides a quite nice admin hub built on Laravel Livewire.
First version of GetCandy was developed in 2018. In 2021, after their newly learnt experience, they decided to create version 2.
</p>

---

### Some numbers

- https://github.com/getcandy/getcandy
- Stars - 467
- Forks - 77
- Last commit - 6 days ago
- Last release - 2.0-beta13.2 - 2022-06-23

---

### Installation

#### Requirements:
<ul>
    <li>PHP ^8.0</li>
    <li>Laravel 8|9</li>
    <li>MySQL 5.7+ / PostgesSQL 9.2+</li>
    <li>PHP extensions: exif, intl and GD</li>
</ul>

---

```shell
composer require getcandy/admin
php artisan vendor:publish --tag=getcandy
```

---

<p>As the GetCandy heavily uses default Laravel user. We need to add GetCandyUser trait to our model.</p>

```php
use GetCandy\Base\Traits\GetCandyUser;
// ...

class User extends Authenticatable
{
    use GetCandyUser;
    // ...
}
```

---

### Search Configuration

<p>GetCandy uses Laravel Scout, for local development collection driver should be enough, but meilisearch driver is recommended.</p>

---

<p>Example of meilisearch setup in Docker</p>

```yaml
meilisearch:
        image: getmeili/meilisearch:latest
        container_name: demo-store-meilisearch
        ports:
            - "7700"
        environment:
            - MEILI_MASTER_KEY=${MEILISEARCH_KEY}
        networks:
            - demo-store
        restart: unless-stopped
```

---

<p>Once we have meilisearch up and running we need to add two packages to our project</p>

```shell
composer require meilisearch/meilisearch-php http-interop/http-factory-guzzle
```

<p>and update our `.env` file:</p>

```
SCOUT_DRIVER=meilisearch
MEILISEARCH_HOST=demo-store-meilisearch:7700
MEILISEARCH_KEY=masterKey
```

---

### Admin Hub

<p>Publish Assets</p>

```shell
php artisan getcandy:hub:install
```

---

### Run Migrations
<p>GetCandy uses table prefix, so it won't interfere with existing tables. It also assumes that our User ID field is a "BIGINT". Both of these settings can be changed in config/getcandy/database.php</p>

---

<p>Then we just run migrate command</p>

```shell
php artisan migrate
```

---

<p>Next we run installer</p>

```shell
php artisan getcandy:install
```

<p>This command will do a few things:</p>

- Copy the config files if we want (usefull for restoring default config)
- Create a default admin user (if required)
- Seeding initial data (like Countries/Currencies/Default Tax etc.)

---

<p>If we set up meilisearch we need to run last command</p>

```shell
php artisan getcandy:meilisearch:setup
```

<p>It will generate any required indexes, filterable and sortable fields, that are needed for scout</p>

---

### Key features

- Custom Attributes
- Tags
- Autogenerated thumbnails / Image resizer
- Inventory managment
- Shipping
- Associations - cross-sells, up-sells, alternatives
- Multilanguage custom URLs for Products and Collection
- Multi-channels

---

<p>Let's take a look at the hub</p>

---

### Extendability

<p>Even at current state GetCandy is quite extendable</p>

---

#### Admin Hub

- Currently only side menu and settings menu for new links
- Slots - simple Livewire compontents that can be added to different pages. Must implement `AbstractSlot` interface.
- Tables - currently only `GetCandy\Facades\OrdersTable`

---

#### Cart Modifiers

<p>If we need to modify a Cart before/after calculation took place. For this GetCandy uses Pipelines.</p>

```php
class CustomCartModifier extends CartModifier
{
    public function calculating(Cart $cart, Closure $next): Cart
    {
        // Do stuff with cart
        return $next($cart);
    }

    public function calculated(Cart $cart, Closure $next): Cart
    {
        // Do stuff with cart
        return $next($cart);
    }
}
```

---

```php
public function boot(
    \GetCandy\Base\CartModifiers $cartModifiers,
) {
    $cartModifiers->add(
        CustomCartModifier::class
    );
}
```

---

#### Custom Field Types

```php
class CustomTextFieldType implements JsonSerializable, FieldType
{
    protected string $value;

    public function jsonSerialize(): string {...}

    public function __construct(string $value = '') {...}

    public function __toString(): string {...}

    public function getValue(): string {...}

    public function setValue(string $value): void {...}

    public function getLabel(): string {...}

    public function getSettingsView(): string {...}

    public function getView(): string {...}

    public function getConfig(): array {...}
}
```

---

#### Models

#### Dynamic Relations

```php
use GetCandy\Models\Order;
use App\Models\Coupon;
 
Order::resolveRelationUsing('coupon', function ($orderModel): hasOne {
    return $orderModel->hasOne(Coupon::class, 'coupon_id');
});
```

---

#### Macroable

```php
use GetCandy\Models\Product;

Product::macro('isDraft', function (): bool {
    return $this->status === 'draft';
});
```

---

#### Order Modifiers

<p>As in cart we can use pipelines, to change order before or after creation</p>

---

#### Payments

```php
use GetCandy\Facades\Payments;

Payments::extend('custom', function ($app): CustomPayment {
    return $app->make(CustomPayment::class);
});
```

---

```php
use GetCandy\Base\DataTransferObjects\PaymentCapture;
use GetCandy\Base\DataTransferObjects\PaymentRefund;
use GetCandy\Base\DataTransferObjects\PaymentAuthorize;
use GetCandy\Models\Transaction;
use GetCandy\PaymentTypes\AbstractPayment;

class CustomPayment extends AbstractPayment
{
    public function authorize(): PaymentAuthorize
    {
        if (!$this->order) {
            if (!$this->order = $this->cart->order) {
                $this->order = $this->cart->getManager()->createOrder();
            }
        }
        
        // ...
        
        return new PaymentAuthorize(true);
    }

    public function refund(Transaction $transaction, int $amount = 0, $notes = null): PaymentRefund
    {
        // ...
        return new PaymentRefund(true);
    }

    public function capture(Transaction $transaction, $amount = 0): PaymentCapture
    {
        // ...
        return new PaymentCapture(true);
    }
}
```

---

#### Search

```php
class ProductObserver
{
    public function indexing(Product $product)
    {
        $product->addSearchableAttribute(
            'color',
            $product->meta->color
        );
    }
    
    /**
     * Called when we are setting up the index via
     * php artisan getcandy:meilisearch:update
     * */
    public function searchSetup(Product $product)
    {
        $product->addFilterableAttributes([
            'color'
        ]);

        $product->addSortableAttributes([
            'color'
        ]);
    }
}
```

```php
Product::search('Shoes')->where('color', 'red');
```

---

##### Taxation

<img style="height: 8em" data-src="presentations/2022-07-06-get-candy/images/morawiecki.jpg">

---

<p>We can change the default tax manager, and replace it with our own</p>

```php
// config/getcandy/taxes.php
return [
    'driver' => 'system',
];
```

---

```php
class CustomTaxDriver implements TaxDriver
{
    public function setShippingAddress(Address $address = null): self {...}
    
    public function setCurrency(Currency $currency): self {...}
    
    public function setBillingAddress(Address $address = null): self {...}
    
    public function setPurchasable(Purchasable $purchasable): self {...}

    public function getBreakdown(int $subTotal): Collection {...}
}
```

---

```php
public function boot()
{
    \GetCandy\Facades\Taxes::extend('custom', function ($app) {
        return $app->make(CustomTaxDriver::class);
    })
}
```

---

### GetCandy Roadmap

https://github.com/orgs/getcandy/projects/5

<img style="height: 8em" data-src="presentations/2022-07-06-get-candy/images/roadmap.png">

---

### Thank you!